name: Build RISC-V GNU Toolchain(Linux)

on:
    # push:
    #   branches: [ main, master ]
    # pull_request:
    #   branches: [ main, master ]
    workflow_dispatch:
        inputs:
            arch:
                description: 'RISC-V Architecture (e.g., rv32im, rv32imc, rv32imac, rv32imafc)'
                required: true
                default: 'rv32im'
                type: string
            abi:
                description: 'RISC-V ABI (e.g., ilp32, ilp32f, ilp32d)'
                required: true
                default: 'ilp32'
                type: string
            extensions:
                description: 'Additional extensions (e.g., _zicsr, _zifencei, empty for none)'
                required: false
                default: ''
                type: string

env:
    TOOLCHAIN_FILENAME: riscv-gnu-toolchain-${{ github.event.inputs.arch }}${{ github.event.inputs.extensions }}_linux

jobs:
    build-toolchain:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  repository: Zxis233/riscv-gnu-toolchain
                  fetch-depth: 1

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    autoconf \
                    automake \
                    autotools-dev \
                    curl \
                    python3 \
                    python3-pip \
                    python3-tomli \
                    libmpc-dev \
                    libmpfr-dev \
                    libgmp-dev \
                    gawk \
                    build-essential \
                    bison \
                    flex \
                    texinfo \
                    gperf \
                    libtool \
                    patchutils \
                    bc \
                    zlib1g-dev \
                    libexpat-dev \
                    ninja-build \
                    git \
                    cmake \
                    libglib2.0-dev \
                    libslirp-dev \
                    mingw-w64

            - name: Configure toolchain
              run: |
                  # ./configure --prefix=/opt/riscv --host=x86_64-w64-mingw32 --with-arch=rv32im_zicsr
                  # ./configure --prefix=/opt/riscv --with-arch=rv32im
                  # ./configure --prefix=/opt/riscv --target=riscv32-unknown-elf --disable-shared --disable-threads --enable-languages=c,c++ --with-pkgversion=0d000721 --with-system-zlib --enable-tls --with-newlib --with-sysroot=/opt/riscv/riscv32-unknown-elf --with-native-system-header-dir=/include --disable-libmudflap --disable-libssp --disable-libquadmath --disable-libgomp --disable-nls --disable-tm-clone-registry --disable-multilib --with-abi=ilp32 --with-arch=rv32im --with-tune=rocket --with-isa-spec=20191213 'CFLAGS_FOR_TARGET=-Os    -mcmodel=medlow' 'CXXFLAGS_FOR_TARGET=-Os    -mcmodel=medlow'
                  ./configure --prefix=/opt/riscv --target=riscv32-unknown-elf --disable-shared --disable-threads --enable-languages=c,c++ --with-pkgversion=0d000721 --with-system-zlib --enable-tls --with-newlib --with-sysroot=/opt/riscv/riscv32-unknown-elf --with-native-system-header-dir=/include --disable-libmudflap --disable-libssp --disable-libquadmath --disable-libgomp --disable-nls --disable-tm-clone-registry --disable-multilib --with-abi=${{ github.event.inputs.abi }} --with-arch=${{ github.event.inputs.arch }}${{ github.event.inputs.extensions }} --with-tune=rocket --with-isa-spec=20191213 'CFLAGS_FOR_TARGET=-Os    -mcmodel=medlow' 'CXXFLAGS_FOR_TARGET=-Os    -mcmodel=medlow'

            - name: Build toolchain
              run: |
                  make -j$(nproc)
              timeout-minutes: 360

            - name: Create installation directory
              run: |
                  sudo mkdir -p /opt/riscv
                  sudo chown -R $USER:$USER /opt/riscv

            - name: Install toolchain
              run: |
                  make install

            - name: Package toolchain
              run: |
                  cd /opt
                  tar -czf ${{ env.TOOLCHAIN_FILENAME }}.tar.gz riscv/
                  ls -lh ${{ env.TOOLCHAIN_FILENAME }}.tar.gz

            - name: Upload toolchain artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.TOOLCHAIN_FILENAME }}
                  path: /opt/${{ env.TOOLCHAIN_FILENAME }}.tar.gz
                  retention-days: 30

            - name: Create Release (on tag)
              if: startsWith(github.ref, 'refs/tags/')
              uses: softprops/action-gh-release@v1
              with:
                  files: /opt/${{ env.TOOLCHAIN_FILENAME }}.tar.gz
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
