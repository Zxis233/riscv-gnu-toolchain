name: Build RISC-V GNU Toolchain(Linux)

on:
  # push:
  #   branches: [ main, master ]
  # pull_request:
  #   branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-toolchain:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: Zxis233/riscv-gnu-toolchain
        submodules: recursive
        fetch-depth: 1
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf \
          automake \
          autotools-dev \
          curl \
          python3 \
          python3-pip \
          python3-tomli \
          libmpc-dev \
          libmpfr-dev \
          libgmp-dev \
          gawk \
          build-essential \
          bison \
          flex \
          texinfo \
          gperf \
          libtool \
          patchutils \
          bc \
          zlib1g-dev \
          libexpat-dev \
          ninja-build \
          git \
          cmake \
          libglib2.0-dev \
          libslirp-dev \
          mingw-w64
    
    - name: Configure toolchain
      run: |
        # ./configure --prefix=/opt/riscv --host=x86_64-w64-mingw32 --with-arch=rv32im_zicsr
        ./configure --prefix=/opt/riscv --with-arch=rv32im
    
    - name: Build toolchain
      run: |
        make -j$(nproc)
      timeout-minutes: 360
    
    - name: Create installation directory
      run: |
        sudo mkdir -p /opt/riscv
        sudo chown -R $USER:$USER /opt/riscv
    
    - name: Install toolchain
      run: |
        make install
    
    - name: Package toolchain
      run: |
        cd /opt
        tar -czf riscv-gnu-toolchain-rv32im_linux.tar.gz riscv/
        ls -lh riscv-gnu-toolchain-rv32im_linux.tar.gz
    
    - name: Upload toolchain artifact
      uses: actions/upload-artifact@v4
      with:
        name: riscv-gnu-toolchain-rv32im_zicsr-mingw32
        path: /opt/riscv-gnu-toolchain-rv32im_zicsr-mingw32.tar.gz
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: /opt/riscv-gnu-toolchain-rv32im_zicsr-mingw32.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
