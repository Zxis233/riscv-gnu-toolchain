name: Release RISC-V Toolchain and Spike (Linux)

on:
    # push:
    #   branches: [ main, master ]
    # pull_request:
    #   branches: [ main, master ]
    workflow_dispatch:

env:
    TOOLCHAIN_FILENAME: riscv-gnu-toolchain-spike_linux
    INSTALL_PREFIX: /opt/riscv

jobs:
    build-toolchain-and-spike:
        runs-on: ubuntu-latest

        steps:
            - name: Free up disk space
              run: |
                  echo "=== Before cleanup ==="
                  df -h
                  # åˆ é™¤ä¸éœ€è¦çš„è½¯ä»¶å’Œæ–‡ä»¶
                  sudo rm -rf /usr/share/dotnet
                  sudo rm -rf /usr/local/lib/android
                  sudo rm -rf /opt/ghc
                  sudo rm -rf /opt/hostedtoolcache/CodeQL
                  sudo docker image prune --all --force
                  sudo apt-get clean
                  echo "=== After cleanup ==="
                  df -h

            - name: Checkout GNU Toolchain repository
              uses: actions/checkout@v4
              with:
                  repository: Zxis233/riscv-gnu-toolchain
                  path: riscv-gnu-toolchain
                  fetch-depth: 1

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    autoconf \
                    automake \
                    autotools-dev \
                    curl \
                    python3 \
                    python3-pip \
                    python3-tomli \
                    libmpc-dev \
                    libmpfr-dev \
                    libgmp-dev \
                    gawk \
                    build-essential \
                    bison \
                    flex \
                    texinfo \
                    gperf \
                    libtool \
                    patchutils \
                    bc \
                    zlib1g-dev \
                    libexpat-dev \
                    ninja-build \
                    git \
                    cmake \
                    libglib2.0-dev \
                    libslirp-dev \
                    device-tree-compiler \
                    libboost-regex-dev \
                    libboost-system-dev

            - name: Create installation directory
              run: |
                  sudo mkdir -p ${{ env.INSTALL_PREFIX }}
                  sudo chown -R $USER:$USER ${{ env.INSTALL_PREFIX }}

            - name: Configure GNU Toolchain
              run: |
                  cd riscv-gnu-toolchain
                  ./configure --prefix=${{ env.INSTALL_PREFIX }} --with-arch=rv64gc --with-abi=lp64d

            - name: Build GNU Toolchain
              run: |
                  cd riscv-gnu-toolchain
                  make -j$(nproc)
              timeout-minutes: 360

            - name: Install GNU Toolchain
              run: |
                  cd riscv-gnu-toolchain
                  make install

            - name: Clean up toolchain build files
              run: |
                  echo "=== Disk usage before cleanup ==="
                  df -h
                  # æ¸…ç†ç¼–è¯‘äº§ç”Ÿçš„ä¸­é—´æ–‡ä»¶
                  cd riscv-gnu-toolchain
                  make clean || true
                  cd ..
                  # åˆ é™¤æºä»£ç ç›®å½•ä»¥é‡Šæ”¾ç©ºé—´
                  rm -rf riscv-gnu-toolchain
                  echo "=== Disk usage after cleanup ==="
                  df -h

            - name: Verify Toolchain installation
              run: |
                  export PATH=${{ env.INSTALL_PREFIX }}/bin:$PATH
                  riscv64-unknown-elf-gcc --version
                  riscv64-unknown-linux-gnu-gcc --version || echo "Linux toolchain not built"

            - name: Checkout pk (Proxy Kernel) repository
              uses: actions/checkout@v4
              with:
                  repository: riscv-software-src/riscv-pk
                  path: riscv-pk
                  fetch-depth: 1

            - name: Configure pk
              run: |
                  cd riscv-pk
                  mkdir build
                  cd build
                  export PATH=${{ env.INSTALL_PREFIX }}/bin:$PATH
                  ../configure --prefix=${{ env.INSTALL_PREFIX }} --host=riscv64-unknown-elf

            - name: Build pk
              run: |
                  cd riscv-pk/build
                  export PATH=${{ env.INSTALL_PREFIX }}/bin:$PATH
                  make -j$(nproc)
              timeout-minutes: 30

            - name: Install pk
              run: |
                  cd riscv-pk/build
                  make install

            - name: Clean up pk build files
              run: |
                  echo "=== Disk usage before pk cleanup ==="
                  df -h
                  # æ¸…ç† pk ç¼–è¯‘æ–‡ä»¶
                  rm -rf riscv-pk
                  echo "=== Disk usage after pk cleanup ==="
                  df -h

            - name: Verify pk installation
              run: |
                  ls -lh ${{ env.INSTALL_PREFIX }}/riscv64-unknown-elf/bin/pk
                  file ${{ env.INSTALL_PREFIX }}/riscv64-unknown-elf/bin/pk

            - name: Checkout Spike repository
              uses: actions/checkout@v4
              with:
                  repository: riscv-software-src/riscv-isa-sim
                  path: riscv-isa-sim
                  fetch-depth: 1
                  submodules: recursive

            - name: Configure Spike
              run: |
                  cd riscv-isa-sim
                  mkdir build
                  cd build
                  ../configure --prefix=${{ env.INSTALL_PREFIX }}

            - name: Build Spike
              run: |
                  cd riscv-isa-sim/build
                  make -j$(nproc)
              timeout-minutes: 60

            - name: Install Spike
              run: |
                  cd riscv-isa-sim/build
                  make install

            - name: Clean up Spike build files
              run: |
                  echo "=== Disk usage before Spike cleanup ==="
                  df -h
                  # æ¸…ç† Spike ç¼–è¯‘æ–‡ä»¶
                  rm -rf riscv-isa-sim
                  echo "=== Disk usage after Spike cleanup ==="
                  df -h

            - name: Verify Spike installation
              run: |
                  ${{ env.INSTALL_PREFIX }}/bin/spike --help
                  echo "Spike version:"
                  ${{ env.INSTALL_PREFIX }}/bin/spike --version || true

            - name: List installed binaries
              run: |
                  echo "=== Installed binaries ==="
                  ls -lh ${{ env.INSTALL_PREFIX }}/bin/ | head -20
                  echo "=== Total files ==="
                  ls ${{ env.INSTALL_PREFIX }}/bin/ | wc -l

            - name: Create backup directory and copy Spike files
              run: |
                  mkdir -p /tmp/spike/bin
                  mkdir -p /tmp/spike/lib
                  mkdir -p /tmp/spike/include
                  mkdir -p /tmp/pk_backup/riscv64-unknown-elf/bin
                  # å¤‡ä»½ Spike ç›¸å…³æ–‡ä»¶
                  cp ${{ env.INSTALL_PREFIX }}/bin/spike* /tmp/spike/bin/ 2>/dev/null || true
                  cp -r ${{ env.INSTALL_PREFIX }}/lib/libspike* /tmp/spike/lib/ 2>/dev/null || true
                  cp -r ${{ env.INSTALL_PREFIX }}/lib/libriscv* /tmp/spike/lib/ 2>/dev/null || true
                  cp -r ${{ env.INSTALL_PREFIX }}/include/spike /tmp/spike/include/ 2>/dev/null || true
                  # å¤‡ä»½ pk ç›¸å…³æ–‡ä»¶
                  cp ${{ env.INSTALL_PREFIX }}/riscv64-unknown-elf/bin/pk /tmp/pk_backup/riscv64-unknown-elf/bin/ 2>/dev/null || true
                  cp ${{ env.INSTALL_PREFIX }}/riscv64-unknown-elf/bin/bbl /tmp/pk_backup/riscv64-unknown-elf/bin/ 2>/dev/null || true
                  echo "=== Spike files backed up ==="
                  find /tmp/spike -type f
                  echo "=== pk files backed up ==="
                  find /tmp/pk_backup -type f

            - name: Remove Spike files from installation
              run: |
                  # ä»ŽåŽŸå®‰è£…ç›®å½•ä¸­ç§»é™¤ Spike æ–‡ä»¶
                  rm -f ${{ env.INSTALL_PREFIX }}/bin/spike*
                  rm -f ${{ env.INSTALL_PREFIX }}/lib/libspike*
                  rm -f ${{ env.INSTALL_PREFIX }}/lib/libriscv*
                  rm -rf ${{ env.INSTALL_PREFIX }}/include/spike
                  # ç§»é™¤ pk æ–‡ä»¶
                  rm -f ${{ env.INSTALL_PREFIX }}/riscv64-unknown-elf/bin/pk
                  rm -f ${{ env.INSTALL_PREFIX }}/riscv64-unknown-elf/bin/bbl

            - name: Package GNU Toolchain only
              run: |
                  cd /opt
                  tar -czf riscv-gnu-toolchain_linux.tar.gz riscv/
                  ls -lh riscv-gnu-toolchain_linux.tar.gz

            - name: Restore Spike files
              run: |
                  # æ¢å¤ Spike æ–‡ä»¶
                  cp -r /tmp/spike/bin/* ${{ env.INSTALL_PREFIX }}/bin/ 2>/dev/null || true
                  cp -r /tmp/spike/lib/* ${{ env.INSTALL_PREFIX }}/lib/ 2>/dev/null || true
                  cp -r /tmp/spike/include/* ${{ env.INSTALL_PREFIX }}/include/ 2>/dev/null || true
                  # æ¢å¤ pk æ–‡ä»¶
                  cp -r /tmp/pk_backup/riscv64-unknown-elf/* ${{ env.INSTALL_PREFIX }}/riscv64-unknown-elf/ 2>/dev/null || true

            - name: Package Spike only
              run: |
                  cd /tmp
                  tar -czf spike-riscv-simulator_linux.tar.gz spike/
                  mv spike-riscv-simulator_linux.tar.gz /opt/
                  ls -lh /opt/spike-riscv-simulator_linux.tar.gz

            - name: Package pk only
              run: |
                  cd /tmp
                  tar -czf riscv-pk_linux.tar.gz pk_backup/
                  mv riscv-pk_linux.tar.gz /opt/
                  ls -lh /opt/riscv-pk_linux.tar.gz

            - name: Upload GNU Toolchain artifact
              uses: actions/upload-artifact@v4
              with:
                  name: riscv-gnu-toolchain_linux
                  path: /opt/riscv-gnu-toolchain_linux.tar.gz
                  retention-days: 30

            - name: Upload Spike artifact
              uses: actions/upload-artifact@v4
              with:
                  name: spike-riscv-simulator_linux
                  path: /opt/spike-riscv-simulator_linux.tar.gz
                  retention-days: 30

            - name: Upload pk artifact
              uses: actions/upload-artifact@v4
              with:
                  name: riscv-pk_linux
                  path: /opt/riscv-pk_linux.tar.gz
                  retention-days: 30

            - name: Generate release info
              id: release_info
              run: |
                  # ç”Ÿæˆæ—¶é—´æˆ³
                  RELEASE_DATE=$(date +'%Y-%m-%d')
                  RELEASE_TIME=$(date +'%H:%M:%S UTC')
                  RELEASE_TAG="build-$(date +'%Y%m%d-%H%M%S')"
                  RELEASE_TITLE="RISC-V Toolchain Build - ${RELEASE_DATE} ${RELEASE_TIME}"
                  
                  # ç”Ÿæˆ Release è¯´æ˜Ž
                  cat > /tmp/release_notes.md << EOF
                  # RISC-V Development Tools
                  
                  **Build Date:** ${RELEASE_DATE}  
                  **Build Time:** ${RELEASE_TIME}  
                  **Build Status:** âœ… Success
                  
                  ## ðŸ“¦ Included Components
                  
                  ### 1. RISC-V GNU Toolchain
                  - **File:** \`riscv-gnu-toolchain_linux.tar.gz\`
                  - **Architecture:** rv64gc
                  - **ABI:** lp64d
                  - **Includes:** gcc, g++, binutils, gdb, newlib
                  
                  ### 2. Spike ISA Simulator
                  - **File:** \`spike-riscv-simulator_linux.tar.gz\`
                  - **Description:** RISC-V ISA Simulator
                  
                  ### 3. Proxy Kernel (pk)
                  - **File:** \`riscv-pk_linux.tar.gz\`
                  - **Description:** Lightweight proxy kernel for Spike
                  
                  ## ðŸš€ Quick Start
                  
                  \`\`\`bash
                  # 1. Extract toolchain
                  tar -xzf riscv-gnu-toolchain_linux.tar.gz -C /opt/
                  export PATH=/opt/riscv/bin:\$PATH
                  
                  # 2. Extract Spike (optional)
                  tar -xzf spike-riscv-simulator_linux.tar.gz
                  cp -r spike/* /opt/riscv/
                  
                  # 3. Extract pk (optional)
                  tar -xzf riscv-pk_linux.tar.gz
                  cp -r pk_backup/riscv64-unknown-elf/* /opt/riscv/riscv64-unknown-elf/
                  
                  # 4. Test installation
                  riscv64-unknown-elf-gcc --version
                  spike --help
                  
                  # 5. Run a simple program
                  spike pk your_program
                  \`\`\`
                  
                  ## ðŸ“ Version Information
                  
                  - **Runner OS:** Ubuntu Latest
                  - **Build Workflow:** GitHub Actions
                  - **Compiler Flags:** -march=rv64gc -mabi=lp64d
                  
                  ## âš ï¸ Notes
                  
                  - All binaries are built for x86_64 Linux
                  - Tested on Ubuntu 22.04+
                  - Total size: ~2-3 GB (all components)
                  
                  ---
                  
                  Built with â¤ï¸ by GitHub Actions
                  EOF
                  
                  # è¾“å‡ºå˜é‡
                  echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
                  echo "release_title=${RELEASE_TITLE}" >> $GITHUB_OUTPUT
                  echo "release_date=${RELEASE_DATE}" >> $GITHUB_OUTPUT
                  echo "release_time=${RELEASE_TIME}" >> $GITHUB_OUTPUT
                  
                  cat /tmp/release_notes.md

            - name: Create Automatic Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ steps.release_info.outputs.release_tag }}
                  name: ${{ steps.release_info.outputs.release_title }}
                  body_path: /tmp/release_notes.md
                  files: |
                      /opt/riscv-gnu-toolchain_linux.tar.gz
                      /opt/spike-riscv-simulator_linux.tar.gz
                      /opt/riscv-pk_linux.tar.gz
                  draft: false
                  prerelease: false
                  make_latest: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
